#!/bin/bash

echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Sneakers API..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "artisan" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Laravel Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
TEMP_DIR="sneakers-api-package"
mkdir -p "$TEMP_DIR"

echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ ÐºÑ€Ð¾Ð¼Ðµ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ñ…
rsync -av \
    --exclude='node_modules/' \
    --exclude='.git/' \
    --exclude='storage/logs/*.log' \
    --exclude='storage/framework/cache/data/*' \
    --exclude='storage/framework/sessions/*' \
    --exclude='storage/framework/views/*' \
    --exclude='vendor/' \
    --exclude='.env' \
    --exclude='*.zip' \
    --exclude='*.tar.gz' \
    ./ "$TEMP_DIR/"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
mkdir -p "$TEMP_DIR/storage/logs"
mkdir -p "$TEMP_DIR/storage/framework/cache/data"
mkdir -p "$TEMP_DIR/storage/framework/sessions"
mkdir -p "$TEMP_DIR/storage/framework/views"
mkdir -p "$TEMP_DIR/bootstrap/cache"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
chmod -R 755 "$TEMP_DIR"
chmod -R 775 "$TEMP_DIR/storage"
chmod -R 775 "$TEMP_DIR/bootstrap/cache"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¿Ð°ÐºÐµÑ‚Ðµ
cat > "$TEMP_DIR/PACKAGE_INFO.txt" <<EOF
Sneakers API Deployment Package
===============================

Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ: $(date)
Ð’ÐµÑ€ÑÐ¸Ñ Laravel: $(grep '"laravel/framework"' composer.json | sed 's/.*: *"\([^"]*\)".*/\1/')

Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ:
1. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² Ð² /var/www/sneakers-api/
2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: sudo bash deploy.sh
3. Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ

ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ API:
- GET /api/sneakers - ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÑ€Ð¾ÑÑÐ¾Ð²Ð¾Ðº
- GET /api/brands - ÑÐ¿Ð¸ÑÐ¾Ðº Ð±Ñ€ÐµÐ½Ð´Ð¾Ð²  
- GET /api/categories - ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹
- GET /api/test-sneakers - Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:
- DEPLOYMENT_INSTRUCTIONS.md - Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ
- QUICK_START.md - Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
- FRONTEND_INTEGRATION.md - Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð¾Ð¼
EOF

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
ARCHIVE_NAME="sneakers-api-$(date +%Y%m%d-%H%M%S).tar.gz"
echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°: $ARCHIVE_NAME"

tar -czf "$ARCHIVE_NAME" -C "$TEMP_DIR" .

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
rm -rf "$TEMP_DIR"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ð°ÐºÐµÑ‚Ðµ
ARCHIVE_SIZE=$(du -h "$ARCHIVE_NAME" | cut -f1)
echo ""
echo "âœ… ÐŸÐ°ÐºÐµÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!"
echo "ðŸ“ Ð¤Ð°Ð¹Ð»: $ARCHIVE_NAME"
echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€: $ARCHIVE_SIZE"
echo ""
echo "ðŸš€ Ð¡Ð¿Ð¾ÑÐ¾Ð±Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€:"
echo ""
echo "1ï¸âƒ£  Ð§ÐµÑ€ÐµÐ· SCP:"
echo "    scp $ARCHIVE_NAME username@your-server-ip:/home/username/"
echo ""
echo "2ï¸âƒ£  Ð§ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¿Ð°Ð½ÐµÐ»ÑŒ Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³Ð°:"
echo "    Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð°Ð¹Ð»Ð¾Ð²Ñ‹Ð¹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€"
echo ""
echo "3ï¸âƒ£  ÐÐ° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ñ€Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ:"
echo "    sudo mkdir -p /var/www/sneakers-api"
echo "    sudo tar -xzf $ARCHIVE_NAME -C /var/www/sneakers-api"
echo "    cd /var/www/sneakers-api"
echo "    sudo bash deploy.sh"
echo ""
echo "ðŸ’¡ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ GitHub Ð´Ð»Ñ Ð±Ð¾Ð»ÐµÐµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð´Ð¾Ð¼!" 